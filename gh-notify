#!/usr/bin/env bash
set -e -o pipefail

GREEN='\033[0;32m'
BLUE='\033[1;34m'
GRAY='\033[0;30m'
NC='\033[0m'

help() {
    cat <<EOF
Usage: gh notify [--flags]

View and search and GitHub notifications. 
Select a pull request or issue to get more info on it.

Flags:
    -a      include all notifications
    -e      exclude notifications matching a string
            Ex. gh notify -e "MyDayJob"
    -f      filter to only notifications matching a string
            Ex. gh notify -f "CoolRepo"
    -n      max number of notifications to show (capped at 100)
            Not specifying will retrieve all notifications.
    -p      show only participating or mention notifications
    -r      mark all notifications as read
    -s      print a static display

Note: -e and -f both support GNU regular expressions.
      -n limits the number in the 1st page of results
         and happens before -e or -f are applied
EOF
}

include_all_flag='false'
only_participating_flag='false'
print_static_flag='false'
mark_read_flag='false'
num_notifications='0'
exclusion_string='XXX_BOGUS_STRING_THAT_SHOULD_NOT_EXIST_XXX'
filter_string=''

while getopts 'e:f:n:pahsr' flag; do
  case "${flag}" in
    n) num_notifications="${OPTARG}" ;;
    e) exclusion_string="${OPTARG}" ;;
    f) filter_string="${OPTARG}" ;;
    a) include_all_flag='true' ;;
    p) only_participating_flag='true' ;;
    s) print_static_flag='true' ;;
    r) mark_read_flag='true' ;;
    h) help
       exit 0 ;;
    *) help 
       exit 1 ;;
  esac
done

get_notifs() {
    page_num=$1
    if [ "$page_num" == "" ]; then
        page_num=1
    fi
    local_page_size=100
    if [ "$num_notifications" != "0" ]; then
        local_page_size=$num_notifications
        echo "$local_page_size" > temp.txt
        echo ""
    fi
    >&2 printf "." # "marching ants" because sometimes this takes a bit.
    gh api -X GET /notifications --cache=20s \
    -f per_page="$local_page_size" -f all="$include_all_flag" -f participating="$only_participating_flag" -f page="$page_num" \
    --template '
    {{- range . -}}
        {{- printf "%s\t%s\t%s\t" .updated_at .subject.type .subject.title -}} 
        {{- printf "%s\t" .repository.full_name -}}
        {{- printf "%s\n" .subject.url -}}
    {{- end -}}'
}


print_notifs() {
    local timestamp type title repo url
    all_notifs=""
    page_num=1
    while true; do
      page=$(get_notifs $page_num)
      if [ "$page" == "" ]; then
          break
      else
          page_num=$((page_num + 1))
        fi
        new_notifs=`
        echo "$page" | while IFS=$'\t' read -r timestamp type title repo url; do
            time="${timestamp:5:11}"
            case "$type" in
                "PullRequest" | "Issue")
                    printf "${GRAY}%s${NC}\t${BLUE}%s${NC}\t%s ${GREEN}#%s${NC}\t%s\n" \
                        "${time/T/ }" "${repo}" "${type}" "${url##*/}" "${title}"
                    ;;
                *)
                    printf "${GRAY}%s${NC}\t${BLUE}%s${NC}\t%s \t%s\n" \
                        "${time/T/ }" "${repo}" "${type}" "${title}"
                    ;;
            esac
        done`
      all_notifs="$all_notifs $new_notifs"
      # this is going to be a bit funky.
      # if you specify a number larger than 100
      # GitHub will ignore it and give you only 100
      if [ "$num_notifications" != "0" ]; then
          break
      fi
    done
    # clear the dots we printed
    >&2 echo -e "\r\033[K"
    # the different pages frequently come back with different
    # column widths.
    # If we insert a tab before the notification type
    # and recolumnize on that everything works out.
    echo "$all_notifs" \
        | sed -e "s/ Issue / \tIssue /" \
              -e "s/ PullRequest / \tPullRequest /" \
              -e "s/ Commit / \tCommit /" \
              -e "s/ Release / \tRelease /" \
        | column -t -s $'\t'
}

filtered_notifs() {
    print_notifs | grep -v "$exclusion_string" | grep "$filter_string"
}

select_notif() {
    local notifs
    notifs="$(filtered_notifs)"
    [ -n "$notifs" ] || exit 0
    fzf --ansi <<< "$notifs"
}

mark_notifs_read() {
    gh api -X PUT /notifications -F read=true --silent 
}

gh_info() {
    local repo type num
    read _ _ repo type num _
    case $type in
        "PullRequest")
            gh pr view "${num#\#}" -R "${repo}"
            ;;
        "Issue")
            gh issue view "${num#\#}" -R "${repo}"
            ;;
        "Release")
            gh release view -R "${repo}"
            ;;
        *)
            ;;
    esac
}

if [[ $mark_read_flag == "true" ]]; then
    mark_notifs_read
    exit 0
fi

if [[ $print_static_flag == "false" ]]; then
    if ! type -p fzf >/dev/null; then
      echo "error: install \`fzf\` or use the -s flag" >&2
      exit 1
    fi
    select_notif | gh_info 
else
    filtered_notifs
fi
